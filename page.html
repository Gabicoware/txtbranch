{% extends "base.html" %}

{% block additional_header %}
    
    <style>
        div.add_page_inactive {display:none;}
        div.add_page_active {display:block;}
        div.title {display:block;}
        div.no_links{color:#888888;font-style:italic}
        .chars_left{font-size:90%; text-align:right; width:100%; max-width:600px;}
        input.invalid{background-color:#FF8888}
        textarea.invalid{background-color:#FF8888}
        .form_link, .form_content{ margin-bottom:2px; width:100%; max-width:600px;}
        a.vote:hover {text-decoration:none;}
        
        div.invalid{background-color:#FF8888}
        
        div.vote{
            display:inline-block;
            width:8px;
            height:10px;
            cursor:pointer;
            background-size:contain;
        }
        div.like_inactive{
            background-image:url("/assets/img/up_arrow_gray.png");
        }
        div.unlike_inactive{
            background-image:url("/assets/img/down_arrow_gray.png");
        }
        div.like_active{
            background-image:url("/assets/img/up_arrow_green.png");
        }
        div.unlike_active{
            background-image:url("/assets/img/down_arrow_red.png");
        }
        div.stats{
            display:inline-block;
            height:20px;
        }
        div.page_link{
        	display:inline-block;
        }
        div.page_link a{
        	color:#000088;
        	font-size:larger;
        }
        div.branch_link span{
        	font-size:smaller;
        }
        div.page_info{
        	 display:inline-block;
        	font-size:smaller;
        }
        
    </style>
    <script>
        
        function getParameterByName(name){
        	name = name.replace(/[\[]/, "\\\[").replace(/[\]]/,"\\\]");
        	var regex = new RegExp("[\\?&#]" + name + "=([^&#]*)"),
        		results = regex.exec(location.hash);
        	if (results == null) {
        		results = regex.exec(location.search);
        	}
        	return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g," "));
        }
        
        var active_page_key = null;
        var page_cache = {};
        
        function toggleLike(page_key,param_value){
        	
        	var page = page_cache[page_key];
        	
            if(page.like_value == param_value){
                param_value = 0;
            }
            
            $.get('/api/v1/likes?page_key='+page_key+'&value='+param_value, function(data) {
                if(data == 'OK'){
                    page.like_value = param_value;
                    updateLikeInfo(page_key,page.like_value);
                }
            });
        }
        
        function updateLikeInfo(page_key,value){
        	
        	var page = page_cache[page_key];
        	
            var like_div = $('#'+page_key+'_like_div');
            var like_count_span = $('#'+page_key+'_like_count_span');
            if(value == 1){
                like_div.addClass("like_active");
                like_div.removeClass("like_inactive");
                like_count_span.text(page.like_count + 1);
            }else{
                like_div.removeClass("like_active");
                like_div.addClass("like_inactive");
                like_count_span.text(page.like_count);
            }
			
            var unlike_div = $('#'+page_key+'_unlike_div');
            var unlike_count_span = $('#'+page_key+'_unlike_count_span');
            if(value == -1){
                unlike_div.addClass("unlike_active");
                unlike_div.removeClass("unlike_inactive");
                unlike_count_span.text(page.unlike_count + 1);
            }else{
                unlike_div.removeClass("unlike_active");
                unlike_div.addClass("unlike_inactive");
                unlike_count_span.text(page.unlike_count);
            }
            
        }
        
        function openPage(page_key){
        	
        	var page = page_cache[page_key];
        	
        	active_page_key = page_key;
        	
    		appendPage(page);
    		
    		updateBranchLinks(page_key);
        }
		function updateBranchLinks(page_key){
        	$("#link_container").empty();

            $.get('/api/v1/pages?parent_page_key='+page_key, function(data,textStatus,xhr) {
            	var jsondata = JSON.parse(data);
            	if(0 < jsondata.result.length){
	            	for(var i =0; i < jsondata.result.length; i++){
	            		var child_page = jsondata["result"][i];
	            		page_cache[child_page.key] = child_page;
	            		appendLink(child_page);
	            	}
            	}else{
		        	var template = $("#no_links_template").html();
		        	$("#link_container").append(template);
		        	
            	}
            });
		}

        
        function appendPage(page){
        	var template = $("#page_template").html();
            
    		template = template.replace(/##page\.content##/g,page.content);
    		template = template.replace(/##page\.link##/g,page.link);
    		template = template.replace(/##page\.key##/g,page.key);
    		template = template.replace(/##page\.child_count##/g,page.child_count);
    		
    		var author_info;
    		
    		if(page["author_name"] != null){
    			
    			var href = "javascript:alert('" +page["author_info"]+ "')";
    			
    			author_info = "by <a href=\""+href+"\">"+page["author_name"]+"</a>";
    		}else{
    			author_info = "by Anonymous";
    		}
    		
    		template = template.replace("##author_info##",author_info);
    		
    		template = template.replace("##page_div_id##",page.key+"_page_div");
    		template = template.replace("##like_div_id##",page.key+"_like_div");
    		template = template.replace("##unlike_div_id##",page.key+"_unlike_div");
    		
    		template = template.replace("##like_count_span_id##",page.key+"_like_count_span");
    		template = template.replace("##unlike_count_span_id##",page.key+"_unlike_count_span");
    		
        	$("#content_container").append(template);
        	
        	updateLikeInfo(page.key,page.like_value);
        }

        function appendLink(page){
        	var template = $("#branch_link_template").html();
        	var branch_link = template;
		    branch_link = branch_link.replace(/##page\.link##/g,page.link);
		    branch_link = branch_link.replace(/##page\.key##/g,page.key);
		    branch_link = branch_link.replace(/##page\.score##/g,(page.child_count + page.like_count - page.unlike_count));
        	$("#link_container").append(branch_link);
        }
        function resetToPage(page_key){
        	active_page_key = page_key;
        	$('#'+page_key+'_page_div').nextAll('div').remove();
        	updateBranchLinks(page_key);
        }
    </script>
    <script id="page_template" type="text/template">
    	<div id="##page_div_id##">
	    	<div>
	            <div class="page_link" >
	                <a href="javascript:resetToPage('##page.key##')">##page.link##</a>
	            </div>
	            <div class="page_info">
	                <div id="##like_div_id##" class="like_div vote" onclick="toggleLike('##page.key##',1);" > </div>
	                <div id="##unlike_div_id##" class="unlike_div vote" onclick="toggleLike('##page.key##',-1);" > </div>
	                <div class="stats">
	                    ( <span id="page_count_span">##page.child_count##</span> / <span id="##like_count_span_id##" >0</span> / <span id="##unlike_count_span_id##" >0</span> ) 
	                </div>
	                ##author_info##
	            </div>
	        </div>
	        <div class="page_content">##page.content##</div>
	        <br />
       	</div>
    </script>
    <script id="branch_link_template" type="text/template">
        <div class="branch_link">
            <a href="javascript:openPage('##page.key##')">##page.link##</a> <span>( ##page.score## )</span><br />
        </div>
    </script>
    <script id="no_links_template" type="text/template">
	    <div class="no_links">
    	    This page does not have any branches yet. You should add one!<br />
        </div>
    </script>
    <script>
        function hideAddPageLink(){
        	
            $('#add_page_link').addClass('add_page_active');
            $('#add_page_link').removeClass('add_page_inactive');
            
            $('#add_page_div').addClass('add_page_inactive');
            $('#add_page_div').removeClass('add_page_active');
            
        	$("#add_page_div").empty();
        }
        function showAddPageLink(){
        	
        	var page = page_cache[active_page_key];
        	
            $('#add_page_link').addClass('add_page_inactive');
            $('#add_page_link').removeClass('add_page_active');
            
            $('#add_page_div').addClass('add_page_active');
            $('#add_page_div').removeClass('add_page_inactive');
            
        	$("#add_page_div").empty();
        	
        	var template = $("#add_branch_form_template").html();
        	
		    template = template.replace(/##page\.key##/g,page.key);
		    
            $("#add_page_div").append(template);
        	
        	
        	var form = $("#"+page.key+"_child_add_page_form")
        	
        	form.ajaxForm({
        		type : 'post',
            	success : function(data, status, xhr){
            		var response = JSON.parse(data);
            		if(response.status == "OK"){
            			hideAddPageLink();
            			
            			var added_page = response.result;
            			
						page_cache[added_page.key] = added_page;
            			
            			openPage(added_page.key);
            		}else{
	            		resetToPage(page.key);
            			for(var key in response.result){
            				if(response.result.hasOwnProperty(key) && messages[key] != null){
            					$("#add_page_div").empty();
					        	var template = $("#has_links_template").html();
							    template = template.replace(/##message##/g,messages[key]);
					            $("#add_page_div").append(template);
            				}
            			}
            		}
            	}
        	});
        	
        	var linkId = "#"+page.key+"_child_link";
        	var contentId = "#"+page.key+"_child_content";
        	
            form.submit(function() {
                
                var hasValidLink = 0 < $(linkId).val().length && $(linkId).val().length < {{link_max}};
                var hasValidContent = 0 < $(contentId).val().length && $(contentId).val().length < {{content_max}};
                
                if(!hasValidLink){
                    $(linkId).addClass('invalid');
                }
                if(!hasValidContent){
                    $(contentId).addClass('invalid');
                }
                return hasValidLink && hasValidContent;
            });
            var form_textareas=[{
                textareaId:linkId,
                maxCharacters: {{link_max}}, // Characters limit  
                statusClass: "chars_left", // The class on the status div 
                notificationClass: "invalid", 
                statusText: "", // The status text 
            },{
                textareaId:contentId,
                maxCharacters: {{content_max}}, // Characters limit  
                statusClass: "chars_left", // The class on the status div 
                notificationClass: "invalid", 
                statusText: "", // The status text 
            }];
        	
			for(var i =0; i < form_textareas.length; i++){ var 
			 	textarea = form_textareas[i];  
			 	$(textarea.textareaId).maxlength(textarea);  
			} 
			
        }
    	var messages = {
    		'has_branches':'The branch could not be added. You can not create any more branches for this page.',
    		'has_identical_link':'The branch could not be added. A branch with an identical link already exists.',
    		'unauthenticated':'The branch could not be added. You are not logged in.',
    	};
    	
    </script>
    <script id="has_links_template" type="text/template">
	    <div class="invalid">##message##</div>
    </script>
    <script id="add_branch_form_template" type="text/template">
        <b>Add a Branch</b>
        <form id="##page.key##_child_add_page_form" action="/api/v1/pages" method="post">
            <input name="parent_page_key" type="hidden" value="##page.key##" />
            <div>
                <label for="##page.key##_child_link">Link</label>
            </div>
            <div>
                <input class="form_link" id="##page.key##_child_link" name="link" rows="1" type="text" />
            </div>
            <br />
            <div>
                <label for="##page.key##_child_content">Content</label>
            </div>
            <div>
                <textarea class="form_content" id="##page.key##_child_content" name="content" rows="3" cols="60" ></textarea>
            </div>
            <br />
            <div>
            	<input type="button" value="Cancel" onclick="hideAddPageLink()"> 
            	&nbsp; 
            	<input type="submit" value="Add Page"></div>
        </form>
    </script>
    <script id="must_login_template" type="text/template">
        <div class="no_links">You must <a href="{{ session_info.url|safe }}">{{ session_info.link_text }}</a> to add a Page.</div>
    </script>
    
{% endblock %}

{% block content %}
        <div id="content_container">&nbsp;</div>
        <hr />
        <div id="link_container">&nbsp;</div>
        <hr />
        <div class="branch_link" id="add_page_link">
	        <a href="javascript:void(0)" onclick="showAddPageLink();">+ Add a Branch</a>
        </div>
        <div id="add_page_div" class="add_page_inactive">&nbsp;</div>
        <script>
        	
        	var page_key = getParameterByName("page_key");
        	
        	if (page_key != "") {
	            $.get('/api/v1/pages?page_key='+page_key, function(data) {
	            	var jsondata = JSON.parse(data);
	            	if(jsondata.result.length == 1){
	            		var page = jsondata["result"][0];
	            		page_cache[page.key] = page;
				        openPage(page.key);
	            	}
	            });
        	};
        	
        
        </script>
{% endblock %}
